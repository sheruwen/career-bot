name: Daily Job Fetch

on:
  workflow_dispatch:
  repository_dispatch:
    types: [cron-fallback]
  schedule:
    # GitHub Actions cron minimum interval is 5 minutes.
    - cron: "*/5 * * * *"

jobs:
  run-daily:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      WEB104_API_URL: ${{ secrets.WEB104_API_URL || 'https://www.104.com.tw/jobs/search/api/jobs' }}
      WEB104_KEYWORD: ${{ secrets.WEB104_KEYWORD || '產品經理' }}
      WEB104_AREA: ${{ secrets.WEB104_AREA || '6001001000' }}
      WEB104_PAGES: ${{ secrets.WEB104_PAGES || '1' }}
      WEB104_ORDER: ${{ secrets.WEB104_ORDER || '15' }}
      WEB104_ASC: ${{ secrets.WEB104_ASC || '0' }}
      WEB104_TIMEOUT: ${{ secrets.WEB104_TIMEOUT || '20' }}
      LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
      LINE_TO_USER_ID: ${{ secrets.LINE_TO_USER_ID }}
      LINE_PUSH_ENDPOINT: ${{ secrets.LINE_PUSH_ENDPOINT || 'https://api.line.me/v2/bot/message/push' }}
      LINE_TIMEOUT: ${{ secrets.LINE_TIMEOUT || '20' }}
      GOOGLE_SHEETS_SPREADSHEET_ID: ${{ secrets.GOOGLE_SHEETS_SPREADSHEET_ID }}
      GOOGLE_SHEETS_WORKSHEET: ${{ secrets.GOOGLE_SHEETS_WORKSHEET || 'Job List' }}
      GOOGLE_SHEETS_APPEND_HEADER: ${{ secrets.GOOGLE_SHEETS_APPEND_HEADER || 'true' }}
      GOOGLE_SHEETS_CREATE_WORKSHEET_IF_MISSING: ${{ secrets.GOOGLE_SHEETS_CREATE_WORKSHEET_IF_MISSING || 'false' }}
      GOOGLE_SHEETS_HEADER_ROW: ${{ secrets.GOOGLE_SHEETS_HEADER_ROW || 'auto' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore seen-job dedup cache
        uses: actions/cache/restore@v4
        with:
          path: outputs/seen_job_keys.txt
          key: seen-job-keys-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            seen-job-keys-${{ github.ref_name }}-

      - name: Prepare Google credentials file
        shell: bash
        run: |
          set -euo pipefail
          RAW_B64='${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON_B64 }}'
          RAW_JSON='${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}'

          if [ -z "$RAW_B64" ] && [ -z "$RAW_JSON" ]; then
            echo "WARN: Google credentials secret is empty, skip Google Sheet append."
            echo "GOOGLE_SHEETS_CREDENTIALS_FILE=" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ -n "$RAW_B64" ] && echo "$RAW_B64" | base64 --decode > /tmp/google_service_account.json 2>/tmp/base64_err.log; then
            echo "Decoded GOOGLE_SHEETS_CREDENTIALS_JSON_B64 as base64"
          elif [ -n "$RAW_JSON" ]; then
            echo "$RAW_JSON" > /tmp/google_service_account.json
            echo "Used GOOGLE_SHEETS_CREDENTIALS_JSON as raw JSON text"
          else
            echo "$RAW_B64" > /tmp/google_service_account.json
            echo "Used GOOGLE_SHEETS_CREDENTIALS_JSON_B64 as raw JSON text fallback"
          fi

          if grep -q '"type"[[:space:]]*:[[:space:]]*"service_account"' /tmp/google_service_account.json; then
            chmod 600 /tmp/google_service_account.json
            echo "GOOGLE_SHEETS_CREDENTIALS_FILE=/tmp/google_service_account.json" >> "$GITHUB_ENV"
          else
            echo "WARN: Google credentials content is invalid, skip Google Sheet append."
            rm -f /tmp/google_service_account.json
            echo "GOOGLE_SHEETS_CREDENTIALS_FILE=" >> "$GITHUB_ENV"
          fi

      - name: Run daily job tool
        run: python3 job_tool.py --source web104 --rules rules.json --output-dir outputs

      - name: Save seen-job dedup cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: outputs/seen_job_keys.txt
          key: seen-job-keys-${{ github.ref_name }}-${{ github.run_id }}

      - name: Upload output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-job-outputs
          path: |
            outputs/jobs_*.md
            outputs/jobs_*.json
            outputs/seen_job_keys.txt
